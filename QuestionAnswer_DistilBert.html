
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <meta name="google-site-verification" content="VXixwtxrf--qUV1swfStEg9jOGPKgUm6C3Ub_vouqmc" />
    <title>MecBar | The Mec Evolution </title>
    <link rel="icon" href="foto/favicon.ico"/>
    <!-- CSS  -->
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    
    <script src="js/jquery-3.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
   
    <link href="https://fonts.googleapis.com/css?family=Raleway|Satisfy" rel="stylesheet">
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />

    <link href="css/style2.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/navbar.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital@1&display=swap" rel="stylesheet"> 
</head>
<header>
    <nav>
        <li class="nav-wrapper back-home" id="head">
            <a href="http://www.mecbar.com/" class="brand-logo mecbar">
                <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                <svg
                   xmlns:osb="http://www.openswatchbook.org/uri/2009/osb"
                   xmlns:dc="http://purl.org/dc/elements/1.1/"
                   xmlns:cc="http://creativecommons.org/ns#"
                   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                   xmlns:svg="http://www.w3.org/2000/svg"
                   xmlns="http://www.w3.org/2000/svg"
                   xmlns:xlink="http://www.w3.org/1999/xlink"
                   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                   width="156"
                   height="64"
                   viewBox="0 0 12.3825 5.08"
                   version="1.1"
                   id="svg8"
                   inkscape:version="1.0 (6e3e5246a0, 2020-05-07)"
                   sodipodi:docname="mecbar.svg">
                  <defs
                     id="defs2">
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient2948">
                      <stop
                         id="stop2946"
                         offset="0"
                         style="stop-color:#c6126a;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient875">
                      <stop
                         id="stop873"
                         offset="0"
                         style="stop-color:#babd06;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3253"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#878734;stop-opacity:1;"
                         offset="0"
                         id="stop3251" />
                    </linearGradient>
                    <linearGradient
                       inkscape:collect="always"
                       id="linearGradient3093">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3089" />
                      <stop
                         style="stop-color:#c6126a;stop-opacity:0;"
                         offset="1"
                         id="stop3091" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3071"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3069" />
                    </linearGradient>
                    <rect
                       x="38.182308"
                       y="80.104469"
                       width="51.135052"
                       height="30.274338"
                       id="rect18630" />
                    <rect
                       x="160.31746"
                       y="77.487633"
                       width="134.35785"
                       height="60.829021"
                       id="rect18624" />
                    <rect
                       x="70.354279"
                       y="28.223705"
                       width="103.27115"
                       height="64.638908"
                       id="rect18618" />
                    <rect
                       x="32.55666"
                       y="25.199898"
                       width="5.2916665"
                       height="43.089287"
                       id="rect18612" />
                    <rect
                       x="34.029621"
                       y="65.792862"
                       width="93.441322"
                       height="26.673161"
                       id="rect18606" />
                    <rect
                       x="10.284417"
                       y="19.486744"
                       width="193.27823"
                       height="129.88597"
                       id="rect18596" />
                    <linearGradient
                       inkscape:collect="always"
                       xlink:href="#linearGradient3093"
                       id="linearGradient3101"
                       gradientUnits="userSpaceOnUse"
                       x1="3.1346149"
                       y1="23.792595"
                       x2="78.606865"
                       y2="23.792595" />
                    <filter
                       height="1"
                       y="-2.5183475e-16"
                       width="1"
                       x="-7.1910066e-17"
                       style="color-interpolation-filters:sRGB"
                       inkscape:label="Blend"
                       id="filter3198">
                      <feBlend
                         in2="SourceGraphic"
                         mode="multiply"
                         result="fbSourceGraphic"
                         id="feBlend3196" />
                      <feColorMatrix
                         result="fbSourceGraphicAlpha"
                         in="fbSourceGraphic"
                         values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0"
                         id="feColorMatrix3200" />
                      <feBlend
                         in2="fbSourceGraphic"
                         id="feBlend3202"
                         mode="multiply"
                         result="blend"
                         in="fbSourceGraphic" />
                      <feGaussianBlur
                         id="feGaussianBlur869"
                         stdDeviation="6.7542215e-15" />
                    </filter>
                    <linearGradient
                       gradientUnits="userSpaceOnUse"
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       id="linearGradient2950"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                    <linearGradient
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       gradientTransform="translate(2.3455617,-9.683066)"
                       gradientUnits="userSpaceOnUse"
                       id="linearGradient3064"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                  </defs>
                  <sodipodi:namedview
                     id="base"
                     pagecolor="#ffffff"
                     bordercolor="#666666"
                     borderopacity="1.0"
                     inkscape:pageopacity="0.0"
                     inkscape:pageshadow="2"
                     inkscape:zoom="0.7"
                     inkscape:cx="355.19772"
                     inkscape:cy="45.714286"
                     inkscape:document-units="mm"
                     inkscape:current-layer="layer1-6"
                     inkscape:document-rotation="0"
                     showgrid="false"
                     inkscape:window-width="1324"
                     inkscape:window-height="747"
                     inkscape:window-x="36"
                     inkscape:window-y="21"
                     inkscape:window-maximized="1"
                     units="px"
                     inkscape:snap-nodes="true"
                     inkscape:object-paths="true"
                     scale-x="0.3" />
                  <metadata
                     id="metadata5">
                    <rdf:RDF>
                      <cc:Work
                         rdf:about="">
                        <dc:format>image/svg+xml</dc:format>
                        <dc:type
                           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                        <dc:title></dc:title>
                      </cc:Work>
                    </rdf:RDF>
                  </metadata>
                  <g
                     inkscape:label="Layer 1"
                     inkscape:groupmode="layer"
                     class="io"
                     id="layer1">
                    <rect
                       ry="7.1295023"
                       rx="10.726023"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="21.245117"
                       width="20.103241"
                       id="rect2824"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                    <g
                       inkscape:label="Layer 1"
                       id="layer1-6"
                       transform="matrix(0.16152221,0.0020121,0,0.13626925,0.08059628,0.86541284)"
                       style="mix-blend-mode:normal;fill:url(#linearGradient2950);fill-opacity:1;stroke-width:6.74038;filter:url(#filter3198);image-rendering:optimizeQuality">
                      <text
                         xml:space="preserve"
                         id="text18594"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18596);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;line-height:125%;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;letter-spacing:0px;word-spacing:0px;fill:url(#linearGradient3064);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                         x="-4.0898471"
                         y="24.876211"
                         id="text18602"
                         transform="matrix(0.75566848,-0.20637119,0.34609071,1.2288151,0,0)"><tspan
                   sodipodi:role="line"
                   id="tspan18600"
                   x="-4.0898471"
                   y="24.876211"
                   style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:url(#linearGradient3064);fill-opacity:1;stroke-width:1.78339px">MecBar</tspan>        <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="0s;light_2.end"
                   dur="1s"
                   values="1;0"
                   attributeName="fill-opacity"
                   id="light_1" />       <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="light_1.end"
                   dur="1s"
                   values="0;1"
                   attributeName="fill-opacity"
                   id="light_2" />           </text>
                      <text
                         xml:space="preserve"
                         id="text18604"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18606);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18610"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18612);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18616"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18618);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18622"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18624);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18628"
                         style="font-style:normal;font-weight:normal;font-size:12.7px;line-height:125%;font-family:sans-serif;text-align:justify;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18630);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="0s;light_2.end"
                         dur="1s"
                         values="1;0"
                         attributeName="fill-opacity"
                         id="light_1" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="light_1.end"
                         dur="1s"
                         values="0;1"
                         attributeName="fill-opacity"
                         id="light_2" />
                    </g>
                    <rect
                       ry="7.1295042"
                       rx="10.726021"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="16.413473"
                       width="25.987757"
                       id="rect871"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                  </g>
                  <style
                     id="style43">
                           #tspan18600 {
                               
                              animation-name: mecOpacity;
                              animation-duration: 2s;
                              animation-iteration-count: infinite;
                              }
                              @keyframes mecOpacity {
                              0%   { fill-opacity:1 }
                                50%  {fill-opacity :0.1; }
                            100% { fill-opacity: 1; }
                              }
                    </style>
                </svg>
                </a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>

            <ul class="right hide-on-med-and-down">
                <!--  <li> <a class="btn" onclick="Materialize.toast('Hello', 4000, 'Ciao' ,4000 )">Touch Me</a> </li>
              -->

              <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
              <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
                <li>
                    <a href=""> </a>
                </li>
                <li>
                    <a href=""> </a>
                </li>
            </ul>
          
              <ul class="side-nav" id="mobile-demo">
               <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
                 <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
            </ul>
        
            </li>
    </nav>
</header>
<script>
    MathJax = {
      loader: {load: ['input/asciimath', 'output/chtml']}
    }
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<div class="center titolo">
    <i>QUESTION - ANSWER - DistilBert - CREATE CUSTOM MODEL    </i>
 </div>
 <div class="testo">

Qui vediamo come creare un modello personalizzato per automatizzare un sistema di domande/risposte in automatico tramite 
una nuova versione di Bert(Bidirectional Encoder Representations from Transformers) la DistilBert che risulta essere più snella di BERT.
Prendiamo un modello pretrained quindi già pronto in lingua inglese e facciamo la fase di Fine Tuning
inserendo dei dati in lingua italiana.  <br>
Si descrive innanzi tutto come creare i dati da inserire per creare il modello. <br>
Si creano 3 file uno per il contesto, uno con le domande ed il terzo con le risposte. <br>
I 3 file verranno poi convertiti in liste contenenti stringhe. La lista delle risposte è composta da 
dictionary composta da key testo con value risposta e dalle key inizio e fine con inici dell'inizio e della fine della 
risposta all'interno del relativo contesto. <br>
Sotto i dati usati per questo esempio.<br><br>
<span class="blu">context:</span><br>
<div class="model00">
["La Mariner 9 fu la prima sonda spaziale a orbitare intorno a Marte nel 1971. Raccolse informazioni inedite sul Pianeta Rosso, rivelando la presenza di grandi vulcani sulla superficie marziana, di enormi sistemi di canaloni e di indizi del fatto che un tempo c'era dell'acqua. Prese anche le prime immagini dettagliate delle due piccole lune di Marte, Phobos e Deimos.",<br>
 "Marte è il quarto pianeta del sistema solare in ordine di distanza dal Sole;[3] è visibile a occhio nudo ed è l'ultimo dei pianeti di tipo terrestre dopo Mercurio, Venere e la Terra. Marte viene chiamato pianeta rosso per via del suo colore caratteristico causato dalla grande quantità di ossido di ferro che lo ricopre,[3] Marte prende il nome dall'omonima divinità della mitologia romana[3] e il suo simbolo astronomico è la rappresentazione stilizzata dello scudo e della lancia del dio.",<br>
 "Rosetta è stata una missione spaziale sviluppata dall'Agenzia spaziale europea e lanciata nel 2004 e finita nel 2016. L'obiettivo della missione fu lo studio della cometa 67P/Churyumov-Gerasimenko. La missione era formata da due elementi: la sonda vera e propria Rosetta e il lander Philae, atterrato il 12 novembre 2014 sulla superficie della cometa 67P/Churyumov Gerasimenko. La missione si è conclusa il 30 settembre 2016, con lo schianto programmato dell'orbiter sulla cometa e disattivazione del segnale.",<br>
 'Vostok 1 (in russo Восток-1) fu la prima missione con equipaggio umano svoltasi nel corso del programma sovietico di esplorazione spaziale Vostok nonché il primo volo umano nello spazio in assoluto. Il 12 aprile 1961 il cosmonauta Jurij Alekseevič Gagarin divenne il primo essere umano a orbitare intorno alla Terra.',<br>
 "il Programma Gemini, o semplicemente Gemini, è il secondo programma di volo umano nello spazio intrapreso dagli Stati Uniti. Pur essendo stato il terzo programma in ordine cronologico ad essere iniziato, venne concluso prima del lancio della prima missione del programma Apollo.Il progetto venne battezzato Gemini poiché la navicella spaziale poteva ospitare un equipaggio di due uomini. Condotto durante il periodo 1963-1966, il suo scopo fu quello di sviluppare le tecniche per i viaggi spaziali avanzati utilizzati poi durante il programma Apollo per portare l'uomo sulla Luna."]
 <br>fonte: Wikipedia  <br>
</div>

<span class="blu">question: </span><br>
<div class="model00">
['Chi fu la Mariner 9 ?',<br>
 'Perchè Marte viene chiamato il pianeta rosso ?',<br>
 "Quale fu l'obiettivo della missione spaziale Rosetta ?",<br>
 'Chi è stato il primo essere umano a orbitare intorno alla Terra ?',<br>
 'Perchè il progetto venne battezzato Programma Gemini ?']<br>
</div>

<span class="blu">answers:</span><br>
 <div class="model00">
 [{'fine': 75, 'inizio': 0,'testo': 'La Mariner 9 fu la prima sonda spaziale a orbitare intorno a Marte nel 1971'},<br>
 {'fine': 255, 'inizio': 183, 'testo': 'Marte viene chiamato pianeta rosso per via del suo colore caratteristico'},<br>
 {'fine': 196, 'inizio': 118,'testo': "L'obiettivo della missione fu lo studio della cometa 67P/Churyumov-Gerasimenko"},<br>
 {'fine': 255, 'inizio': 217,'testo': 'il cosmonauta Jurij Alekseevič Gagarin'},<br>
 {'fine': 386, 'inizio': 278, 'testo': 'Il progetto venne battezzato Gemini poiché la navicella spaziale poteva ospitare un equipaggio di due uomini'}]
 </div>
  
  <br><br>

A questo punto vediamo il programma per creare un modello facendo il Fine-Tuning di un modello 
pretrained.<br>


<div class="model6">
!pip install transformers<br>
</div>
<br>
<div class="model6">
from torch.utils.data import DataLoader<br>
from transformers import AdamW<br>
from transformers import DistilBertTokenizerFast<br>
from transformers import DistilBertForQuestionAnswering<br>
from torch.utils.data import Dataset<br>
import torch<br>
from torch import nn<br>
import pandas as pd<br>
</div>
<div class="model6">
from google.colab import drive<br>
drive.mount('/content/drive/')<br>
</div>
<br>
<div class="model6">
def carica_dati():<br><br>
<span style="margin-left:30px">""" carica dati e crea 1 lista x context data, 1 lista per question data e un dictionary per answer """</span><br><br>
 <span style="margin-left:30px">answers= []</span><br>
 <span style="margin-left:30px">filename_context = "/content/drive/My Drive/crypto/QA_BERT.txt"</span><br>
 <span style="margin-left:30px">contesto = pd.read_csv(filename_context, sep='\n', header=None)</span><br>
  <span style="margin-left:30px">filename_domande = "/content/drive/My Drive/crypto/domande.txt"</span><br>
 <span style="margin-left:30px">domande = pd.read_csv(filename_domande, sep='\n', header=None)</span><br>
 <span style="margin-left:30px">filename_risposte = "/content/drive/My Drive/crypto/risposte.txt"</span><br>
<span style="margin-left:30px">risposte = pd.read_csv(filename_risposte, sep='\n', header=None)</span><br>
<br>
<span style="margin-left:30px">context = [ x.strip() for x in contesto[0]] </span><br>
<span style="margin-left:30px"> question = [ x.strip() for x in domande[0]] </span><br>
<span style="margin-left:30px">risposte = [ x.strip() for x in risposte[0]] </span><br>
<br>
 <span style="margin-left:30px">for i in range(len(risposte)):</span><br>
 <span style="margin-left:60px"> answer = dict([('testo', '' ),('inizio', ''), ('fine','')])</span><br>
 <span style="margin-left:60px">answer['testo'] = risposte[i]</span><br>
 <span style="margin-left:60px">answer['inizio']= context[i].find(risposte[i])</span><br>
  <span style="margin-left:60px">answer['fine'] = context[i].find(risposte[i])  + len(risposte[i])</span><br>
 <span style="margin-left:30px"> answers.append(answer)</span><br>
 <br>
 <span style="margin-left:30px"> return context, question, answers</span><br>
</div>
<div class="model6">
class CreaDatasetSquad(Dataset):<br><br>
<span style="margin-left:30px">def __init__(self, data):</span><br>
 <span style="margin-left:60px"> self.data = data</span><br><br>
 <span style="margin-left:30px"> def __getitem__(self, i):</span><br>
 <span style="margin-left:60px">return {key: torch.tensor(value[i]) for key, value in self.data.items()}</span><br><br>
  <span style="margin-left:30px"> def __len__(self):</span><br>
  <span style="margin-left:60px">return len(self.data.input_ids)</span><br>

</div>
<div class="model6">
def insTokenPositions(train, answers):<br>
<br>
<span style="margin-left:30px"> inizio = []</span><br>
<span style="margin-left:30px">fine = []</span><br><br>
 <span style="margin-left:30px"> for i in range(len(answers)):</span><br>
  <span style="margin-left:60px">inizio.append(train.char_to_token(i, answers[i]['inizio']))</span><br>
 <span style="margin-left:60px">fine.append(train.char_to_token(i, answers[i]['fine'] - 1))</span><br>
 <span style="margin-left:60px"> # se lo non trova in answers inserisce lunghezza massima prevista dal modello </span><br><br>
 <span style="margin-left:60px">if inizio[-1] is None:</span><br>
 <span style="margin-left:90px">inizio[-1] = tokenizer.model_max_length</span><br><br>
 <span style="margin-left:60px"> if fine[-1] is None:</span><br>
  <span style="margin-left:90px">fine[-1] = tokenizer.model_max_length</span><br><br>
<span style="margin-left:30px">train.update({'inizio': inizio, 'fine': fine})</span><br>

</div>
Qui carichiamo i dati e scarichiamo gli oggetti già disponibili come il tokenizer ed il 
modello pretrained.
<div class="model6">
context, question, answers = carica_dati()<br>
<br>
tokenizer = DistilBertTokenizerFast.from_pretrained('distilbert-base-uncased')<br>
model = DistilBertForQuestionAnswering.from_pretrained("distilbert-base-uncased")<br>
</div>
Creazione del train_dataset con la tokenizzazione del context e relativa question. Nel riquadro 
vediamo il file creato con input_ids ed attention_mask.
<div class="model6">
train_dataset = tokenizer(context, question, truncation=True, padding=True)<br><br>
<div class="model66">
{'input_ids': [[101, 2474, 3884, 2099, 1023 ... 102]], 'attention_mask': [[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1 .... ]} <br>
</div>
</div>
Ora nel train_dataset si inseriscono i token dell'inizio e fine della risposta.
<div class="model6">
insTokenPositions(train_dataset, answers)<br>
<div class="model66">
{'input_ids': [[101, 2474, 3884, 2099, 1023 ... 102]], 'attention_mask': [[1, 1... 1]], 'inizio': [1, 70, 42, 75, 84], 'fine': [23, 92, 68, 88, 118]} <br>
</div>
</div>
Con la funzione CreaDatasetSquad creiamo il nostro dataset come un dataset Squad(The Stanford Question Answering Dataset).
Nel riquadro successivo vediamo nel dettaglio l'item 1.

<div class="model6">
train_dataset = CreaDatasetSquad(train_dataset) <br><br>
</div>
<div class="model6">
train_dataset.__getitem__(1) <br><br>
<div class="model66">
{'attention_mask': tensor([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, <br>
<span style="margin-left:30px">1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
<span style="margin-left:30px">1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
 <span style="margin-left:30px"> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
 <span style="margin-left:30px"> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
  <span style="margin-left:30px"> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
 <span style="margin-left:30px">1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
 <span style="margin-left:30px">1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,</span><br>
 <span style="margin-left:30px">1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0]),</span><br>
 'fine': tensor(92), <br>
 'inizio': tensor(70),<br>
 'input_ids': tensor([  101, 20481,  2063,  1041,  6335, 24209,  8445,  2080, 24624,  7159,<br>
 <span style="margin-left:30px"> 2050,  3972, 24761, 18532,  2050,  5943,  2063,  1999,  2030, 10672,</span><br>
<span style="margin-left:30px">4487,  4487, 12693,  4143, 17488,  7082,  1025,  1031,  1017,  1033,</span><br>
 <span style="margin-left:30px">1041, 25292, 12322,  9463,  1037,  1051, 25955,  2080, 16371,  3527,</span><br>
 <span style="margin-left:30px">3968,  1041,  1048,  1005, 17359,  3775,  5302, 14866, 24624,  7159,</span><br>
 <span style="margin-left:30px">2072,  4487,  5955,  2080, 25170,  3367,  2890,  2079,  6873, 21442,</span><br>
   <span style="margin-left:30px">10841,  9488,  1010,  2310,  3678,  2063,  1041,  2474, 14403,  1012,</span><br>
  <span style="margin-left:30px">20481,  2063, 20098,  2638,  9610,  8067,  3406, 24624,  7159,  2050,</span><br>
  <span style="margin-left:30px"> 5811,  2080,  2566,  3081,  3972, 10514,  2080,  3609,  2063, 14418,</span><br>
 <span style="margin-left:30px">12079,  6553,  2080,  6187, 10383,  3406, 17488,  2721,  9026, 24110,</span><br>
 <span style="margin-left:30px">3775,  2696,  4487,  9808,  5332,  3527,  4487, 10768, 18933, 18178,</span><br>
  <span style="margin-left:30px"> 8840,  7043, 28139,  1010,  1031,  1017,  1033, 20481,  2063,  3653,</span><br>
  <span style="margin-left:30px">13629,  6335,  2053,  4168, 17488,  2140,  1005, 18168, 10698,  2863,</span><br>
  <span style="margin-left:30px">4487,  6371,  6590,  8611, 10210, 12898, 10440,  3142,  2050,  1031,</span><br>
      <span style="margin-left:30px"> 1017,  1033,  1041,  6335, 10514,  2080, 21934, 14956,  2080, 28625,</span><br>
 <span style="margin-left:30px"> 3630,  7712,  2080,  1041,  2474,  9680, 28994,  4765, 16103,  5643,</span><br>
 <span style="margin-left:30px">25931, 10993,  4143,  2696, 12418,  2080,  8040,  6784,  2080,  1041,</span><br>
 <span style="margin-left:30px">8611, 17595,  7405,  3972,  4487,  2080,  1012,   102, 21836,  2063,</span><br>
  <span style="margin-left:30px">20481,  2063, 20098,  2638,  9610,  8067,  3406,  6335, 24624,  7159,</span><br>
  <span style="margin-left:30px">2050,  5811,  2080,  1029,   102,     0,     0,     0,     0,     0,</span><br>
 <span style="margin-left:30px"> 0,     0,     0])}</span>
</div>
</div>
Il passo successivo è quello di creare con DataLoader(by Torch) un iterator sul file di input.
Poi si definiscono dei parametri come l'optimizer qui viene applicato quello creato appositamente 
per questo modello. 
 <div class="model6">
trainI = DataLoader(train_dataset, batch_size=16, shuffle=True)<br>
<br>
EPOCHS = 200<br>
totalLoss = 0<br>
check_iter = 1 <br>
<br>   
optim = AdamW(model.parameters(), lr=5e-5)<br>            
device = torch.device('cuda') if torch.cuda.is_available() else torch.device('cpu')<br>
<br>      
model.train()<br>
model.to(device)<br>

 </div>
Passiamo alla fase di training per la creazione del modello. Qui si applicano 200 epochs visto l'esiguo numero 
di dati inseriti nel modello. 
<div class="model6">
for epoch in range(EPOCHS):<br><br>
<span style="margin-left:30px">for i,train in  enumerate(trainI):</span><br>
<span style="margin-left:60px"> optim.zero_grad()</span><br><br>
 <span style="margin-left:60px"> # estrazione dati processati precedentemente</span><br>
 <span style="margin-left:60px">input_ids = train['input_ids'].to(device)</span><br>
 <span style="margin-left:60px">attention_mask = train['attention_mask'].to(device)</span><br>
 <span style="margin-left:60px"> start_positions = train['inizio'].to(device)</span><br>
   <span style="margin-left:60px">  end_positions = train['fine'].to(device)</span><br><br>
  <span style="margin-left:60px"> outputs = model(input_ids, attention_mask=attention_mask, start_positions=start_positions, end_positions=end_positions)</span><br>
  <span style="margin-left:60px"> loss = outputs[0]</span><br>
  <span style="margin-left:60px"> loss.backward()</span><br>
  <span style="margin-left:60px"> optim.step()</span><br>
  <span style="margin-left:60px"> totalLoss += loss.item()</span><br><br>
 <span style="margin-left:60px">if (i + 1) % check_iter  == 0:</span><br>
 <span style="margin-left:90px"> lossAvg = totalLoss / check_iter </span><br>
 <span style="margin-left:90px"> print("epoch %d, loss = %.3f" % (epoch + 1, lossAvg  ))</span><br>
 <span style="margin-left:90px"> totalLoss = 0</span><br>
</div>

 <br><br><br>
Una volta creato il modello passiamo ad effettuare una valutazione dello stesso selezionando anche 
una domanda ed il relativo contesto.  
<div class="model00">
model.eval()<br>
domanda= question[3]  # Chi è stato il primo essere umano a orbitare intorno alla Terra ?<br>
contesto = context[3]<br><br>
</div>

<div class="model00">
tokenCod = tokenizer.encode_plus(domanda,contesto)<br>
input_ids, attention_mask = tokenCod["input_ids"], tokenCod["attention_mask"]<br>
inizioRisultato, fineRisultato = model(torch.tensor([input_ids]), attention_mask=torch.tensor([attention_mask]))<br>
<br>
</div>
<div class="model00">
risTokens = input_ids[torch.argmax(inizioRisultato) : torch.argmax(fineRisultato)+1]<br>
answerTokens = tokenizer.convert_ids_to_tokens(risTokens , skip_special_tokens=True)<br>
<br>
tokensTuttInp = tokenizer.convert_ids_to_tokens(input_ids)<br><br>
</div>
<div class="model00">
AnswerPredicted = tokenizer.convert_tokens_to_string(answerTokens)<br>
<br>
tokensTuttInp :<br><br>
<div class="model66">
['il', 'co', '##smo', '##naut', '##a', 'ju', '##ri', '##j', 'ale', '##ks', '##ee', '##vic', 'gaga', '##rin']<br>
<br>
</div>
<br>
Risposta predicted : <br>
<div class="model66">
il cosmonauta jurij alekseevic gagarin<br><br>
</div>
<br>
</div>


 </div>

</html>


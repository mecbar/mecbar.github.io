
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <meta name="google-site-verification" content="VXixwtxrf--qUV1swfStEg9jOGPKgUm6C3Ub_vouqmc" />
    <title>MecBar | The Mec Evolution </title>
    <link rel="icon" href="foto/favicon.ico"/>
    <!-- CSS  -->
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    
    <script src="js/jquery-3.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
   
    <link href="https://fonts.googleapis.com/css?family=Raleway|Satisfy" rel="stylesheet">
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />

    <link href="css/style2.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/navbar.css" type="text/css" rel="stylesheet" media="screen,projection" />
 
</head>

<header>
    <nav>
        <li class="nav-wrapper back-home" id="head">
            <a href="http://www.mecbar.com/" class="brand-logo mecbar">
                <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                <svg
                   xmlns:osb="http://www.openswatchbook.org/uri/2009/osb"
                   xmlns:dc="http://purl.org/dc/elements/1.1/"
                   xmlns:cc="http://creativecommons.org/ns#"
                   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                   xmlns:svg="http://www.w3.org/2000/svg"
                   xmlns="http://www.w3.org/2000/svg"
                   xmlns:xlink="http://www.w3.org/1999/xlink"
                   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                   width="156"
                   height="64"
                   viewBox="0 0 12.3825 5.08"
                   version="1.1"
                   id="svg8"
                   inkscape:version="1.0 (6e3e5246a0, 2020-05-07)"
                   sodipodi:docname="mecbar.svg">
                  <defs
                     id="defs2">
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient2948">
                      <stop
                         id="stop2946"
                         offset="0"
                         style="stop-color:#c6126a;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient875">
                      <stop
                         id="stop873"
                         offset="0"
                         style="stop-color:#babd06;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3253"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#878734;stop-opacity:1;"
                         offset="0"
                         id="stop3251" />
                    </linearGradient>
                    <linearGradient
                       inkscape:collect="always"
                       id="linearGradient3093">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3089" />
                      <stop
                         style="stop-color:#c6126a;stop-opacity:0;"
                         offset="1"
                         id="stop3091" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3071"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3069" />
                    </linearGradient>
                    <rect
                       x="38.182308"
                       y="80.104469"
                       width="51.135052"
                       height="30.274338"
                       id="rect18630" />
                    <rect
                       x="160.31746"
                       y="77.487633"
                       width="134.35785"
                       height="60.829021"
                       id="rect18624" />
                    <rect
                       x="70.354279"
                       y="28.223705"
                       width="103.27115"
                       height="64.638908"
                       id="rect18618" />
                    <rect
                       x="32.55666"
                       y="25.199898"
                       width="5.2916665"
                       height="43.089287"
                       id="rect18612" />
                    <rect
                       x="34.029621"
                       y="65.792862"
                       width="93.441322"
                       height="26.673161"
                       id="rect18606" />
                    <rect
                       x="10.284417"
                       y="19.486744"
                       width="193.27823"
                       height="129.88597"
                       id="rect18596" />
                    <linearGradient
                       inkscape:collect="always"
                       xlink:href="#linearGradient3093"
                       id="linearGradient3101"
                       gradientUnits="userSpaceOnUse"
                       x1="3.1346149"
                       y1="23.792595"
                       x2="78.606865"
                       y2="23.792595" />
                    <filter
                       height="1"
                       y="-2.5183475e-16"
                       width="1"
                       x="-7.1910066e-17"
                       style="color-interpolation-filters:sRGB"
                       inkscape:label="Blend"
                       id="filter3198">
                      <feBlend
                         in2="SourceGraphic"
                         mode="multiply"
                         result="fbSourceGraphic"
                         id="feBlend3196" />
                      <feColorMatrix
                         result="fbSourceGraphicAlpha"
                         in="fbSourceGraphic"
                         values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0"
                         id="feColorMatrix3200" />
                      <feBlend
                         in2="fbSourceGraphic"
                         id="feBlend3202"
                         mode="multiply"
                         result="blend"
                         in="fbSourceGraphic" />
                      <feGaussianBlur
                         id="feGaussianBlur869"
                         stdDeviation="6.7542215e-15" />
                    </filter>
                    <linearGradient
                       gradientUnits="userSpaceOnUse"
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       id="linearGradient2950"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                    <linearGradient
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       gradientTransform="translate(2.3455617,-9.683066)"
                       gradientUnits="userSpaceOnUse"
                       id="linearGradient3064"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                  </defs>
                  <sodipodi:namedview
                     id="base"
                     pagecolor="#ffffff"
                     bordercolor="#666666"
                     borderopacity="1.0"
                     inkscape:pageopacity="0.0"
                     inkscape:pageshadow="2"
                     inkscape:zoom="0.7"
                     inkscape:cx="355.19772"
                     inkscape:cy="45.714286"
                     inkscape:document-units="mm"
                     inkscape:current-layer="layer1-6"
                     inkscape:document-rotation="0"
                     showgrid="false"
                     inkscape:window-width="1324"
                     inkscape:window-height="747"
                     inkscape:window-x="36"
                     inkscape:window-y="21"
                     inkscape:window-maximized="1"
                     units="px"
                     inkscape:snap-nodes="true"
                     inkscape:object-paths="true"
                     scale-x="0.3" />
                  <metadata
                     id="metadata5">
                    <rdf:RDF>
                      <cc:Work
                         rdf:about="">
                        <dc:format>image/svg+xml</dc:format>
                        <dc:type
                           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                        <dc:title></dc:title>
                      </cc:Work>
                    </rdf:RDF>
                  </metadata>
                  <g
                     inkscape:label="Layer 1"
                     inkscape:groupmode="layer"
                     class="io"
                     id="layer1">
                    <rect
                       ry="7.1295023"
                       rx="10.726023"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="21.245117"
                       width="20.103241"
                       id="rect2824"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                    <g
                       inkscape:label="Layer 1"
                       id="layer1-6"
                       transform="matrix(0.16152221,0.0020121,0,0.13626925,0.08059628,0.86541284)"
                       style="mix-blend-mode:normal;fill:url(#linearGradient2950);fill-opacity:1;stroke-width:6.74038;filter:url(#filter3198);image-rendering:optimizeQuality">
                      <text
                         xml:space="preserve"
                         id="text18594"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18596);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;line-height:125%;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;letter-spacing:0px;word-spacing:0px;fill:url(#linearGradient3064);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                         x="-4.0898471"
                         y="24.876211"
                         id="text18602"
                         transform="matrix(0.75566848,-0.20637119,0.34609071,1.2288151,0,0)"><tspan
                   sodipodi:role="line"
                   id="tspan18600"
                   x="-4.0898471"
                   y="24.876211"
                   style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:url(#linearGradient3064);fill-opacity:1;stroke-width:1.78339px">MecBar</tspan>        <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="0s;light_2.end"
                   dur="1s"
                   values="1;0"
                   attributeName="fill-opacity"
                   id="light_1" />       <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="light_1.end"
                   dur="1s"
                   values="0;1"
                   attributeName="fill-opacity"
                   id="light_2" />           </text>
                      <text
                         xml:space="preserve"
                         id="text18604"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18606);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18610"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18612);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18616"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18618);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18622"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18624);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18628"
                         style="font-style:normal;font-weight:normal;font-size:12.7px;line-height:125%;font-family:sans-serif;text-align:justify;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18630);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="0s;light_2.end"
                         dur="1s"
                         values="1;0"
                         attributeName="fill-opacity"
                         id="light_1" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="light_1.end"
                         dur="1s"
                         values="0;1"
                         attributeName="fill-opacity"
                         id="light_2" />
                    </g>
                    <rect
                       ry="7.1295042"
                       rx="10.726021"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="16.413473"
                       width="25.987757"
                       id="rect871"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                  </g>
                  <style
                     id="style43">
                           #tspan18600 {
                               
                              animation-name: mecOpacity;
                              animation-duration: 2s;
                              animation-iteration-count: infinite;
                              }
                              @keyframes mecOpacity {
                              0%   { fill-opacity:1 }
                                50%  {fill-opacity :0.1; }
                            100% { fill-opacity: 1; }
                              }
                    </style>
                </svg>
                </a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>

            <ul class="right hide-on-med-and-down">
                <!--  <li> <a class="btn" onclick="Materialize.toast('Hello', 4000, 'Ciao' ,4000 )">Touch Me</a> </li>
              -->

              <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
              <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
                <li>
                    <a href=""> </a>
                </li>
                <li>
                    <a href=""> </a>
                </li>
            </ul>
          
              <ul class="side-nav" id="mobile-demo">
               <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
                 <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
            </ul>
        
            </li>
    </nav>
</header>
<script>
    MathJax = {
      loader: {load: ['input/asciimath', 'output/chtml']}
    }
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<body>
<div class="center titolo">
    <i>CNN con PyTorch e Qiskit</i>
 </div>

<div class="testo">
Per la serie di Convolutional Neural Network ora vediamo come integrare un modello classico creato con 
PyTorch con la Quantistica Computazionale e nello specifico il framework Qiskit di IBM. <br>
Qui prendiamo il dataset MINST contenete i numeri da 0 a 9 da cui estraiamo solo gli 0 e gli 1 per poi inserire nel modello 
un layer costruito tramite un circuito quantistico che ci ritornerà l'indicazione del numero inserito. <br>

<br><br>
<img src="foto/qcnnsce.png" width="100%" height="400px">
<br><br>

Passiamo ad inserire il programma dopo aver visto lo schema logico sopra esposto. 
<br>
<div class="model">

    import numpy as np<br>
    import matplotlib.pyplot as plt<br>
    
    import torch<br>
    from torch.autograd import Function<br>
    from torchvision import datasets, transforms<br>
    import torch.optim as optim<br>
    import torch.nn as nn<br>
    import torch.nn.functional as F<br>
    
    import qiskit<br>
    from qiskit.visualization import *<br>
    from qiskit.aqua.operators import Z, Y, X, StateFn<br>
    from qiskit import QuantumCircuit, QuantumRegister, ClassicalRegister, execute, Aer<br>
</div>
Dopo aver importato le librerie necessarie passiamo a definire un nuovo oggetto.<br>
Con la class Circuit definiamo un circuito quantistico con Qiskit di un qubit dove inseriamo un gate H per creare la superposition 
e un gate Ry(theta) che effettua una rotazione nell'asse delle y in base al parametro theta che verrà inserito 
nel circuito da un layer nel CNN come poi vedremo.<br>
<div class="row">
<div class="col l3 m12 s12">
<img src="foto/ry2.gif" width="150px" height="150px">
</div>
<div class="col l9 m12 s12">
<br>Con il metodo go faremo una simulazione del 
circuito per poi calcolare il risultato(le probabilità di ogni possibile stato del qubit nel nostro caso 0 o 1). 
</div>
</div>


 <div class="model">
    <span class="pyc"> class </span> Circuit:<br>

<span style="margin-left:30px">     """ </span><br>
    <span style="margin-left:30px">    quantum circuit  </span><br>
        <span style="margin-left:30px">     """</span><br>
    
<span style="margin-left:30px"> <span class="pyc">  def </span> __init__(self, qubits, backend, shots):</span><br>
 <span style="margin-left:60px"> super(Circuit,self).__init__()</span><br>
 <span style="margin-left:60px">       self.circuit = qiskit.QuantumCircuit(qubits)</span><br>
 <span style="margin-left:60px">       qub = [i for i in range(qubits)]</span><br>
        
<span style="margin-left:60px">       self.theta =<span class="pyc2"> qiskit.circuit.Parameter('theta')</span></span><br>
        
 <span style="margin-left:60px">       self.circuit.h(qub)</span><br>
<span style="margin-left:60px">       self.circuit.barrier()</span><br>
<span style="margin-left:60px">        self.circuit.ry(self.theta, qub)</span><br>
        
<span style="margin-left:60px">        self.circuit.measure_all()</span><br>
      
<span style="margin-left:60px">        self.backend = backend</span><br>
 <span style="margin-left:60px">        self.shots = shots</span><br>
 <br>
 <span style="margin-left:30px"> <span class="pyc">  def </span> go(self, theta) -> None:</span><br>
    <span style="margin-left:60px">        job = qiskit.execute(self.circuit, </span><br>
    <span style="margin-left:120px">                           self.backend, </span><br>
    <span style="margin-left:120px">                            shots = self.shots,</span><br>
    <span style="margin-left:120px">                             parameter_binds = [{self.theta: theta} for theta in theta])</span><br>
        
    <span style="margin-left:60px">    result = job.result().get_counts(self.circuit)</span><br>
        
    <span style="margin-left:60px">     res = np.array(list(result.values()))</span><br>
    <span style="margin-left:60px">      valori = np.array(list(result.keys())).astype(float)</span><br>
        
    <span style="margin-left:60px">       # Calcola probabilità  per ogni qubit state</span><br>
    <span style="margin-left:60px">        probabilità = res / self.shots</span><br>
    <span style="margin-left:60px">  # misurazione del qubit state</span><br>
    <span style="margin-left:60px">  z_meas = np.sum(valori * probabilità)</span><br>
        
    <span style="margin-left:60px">  return np.array([z_meas])</span><br>
    <br><br>
 </div>

 Passiamo ora a definire la class myFunction che deriva dalla Function fornita da PyTorch 
per gestire le fasi di backward(backpropagation) e forward. <br>
Da notare che vengono creati 2 staticmethod a cui si associano i ctx e non i self per rendere i 2 metodi 
direttamente eseguibili come fossero funzioni senza che la class venga istanziata. <br>
Nella backward vengono calcolati i gradients per la backpropagation mentre nella forward si chiama 
il circuito definito in precedenza per ottenere il risultato e inserirlo come tensor nella NN. 


<div class="model">

    <span class="pyc">class </span> myFunction(Function):<br>
<span style="margin-left:30px"> """ Function per gestire Backward e Forward """</span><br>
    
<span style="margin-left:30px">  <span class="pyc"> @staticmethod</span> </span><br>
<span style="margin-left:30px">  <span class="pyc"> def </span> forward(ctx, input, circuit, shift):</span><br>
<span style="margin-left:60px">   """ Forward NN computation """</span><br>
<span style="margin-left:60px">  ctx.shift = shift</span><br>
<span style="margin-left:60px"> <span class="pyc2">ctx.quantumCircuit = circuit</span></span><br>
<span style="margin-left:60px"> z_meas =<span class="pyc2"> ctx.quantumCircuit.go(input[0].tolist())</span> </span><br>
<span style="margin-left:60px"> result = torch.tensor([z_meas])</span><br>
<span style="margin-left:60px"> <span class="pyc2">ctx.save_for_backward(input, result)</span> </span><br>
<br>
<span style="margin-left:60px">return result</span><br>
<br>    
<span style="margin-left:30px"> <span class="pyc"> @staticmethod</span> </span><br>
    <span style="margin-left:30px"> <span class="pyc"> def </span> backward(ctx, output):</span><br>
    <span style="margin-left:60px"> """ Backward NN computation """</span><br>
        <span style="margin-left:60px">input, z_meas = ctx.saved_tensors</span><br>
        <span style="margin-left:60px">input_list = np.array(input.tolist())</span><br>
        
        <span style="margin-left:60px">shift_right = input_list + np.ones(input_list.shape) * ctx.shift</span><br>
        <span style="margin-left:60px">shift_left = input_list - np.ones(input_list.shape) * ctx.shift</span><br>
        
        <span style="margin-left:60px"> gradients = []</span><br>
        <span style="margin-left:60px">for i in range(len(input_list)):</span><br>
        <span style="margin-left:90px">right = <span class="pyc2">ctx.quantumCircuit.go(shift_right[i])</span> </span><br>
            <span style="margin-left:90px">left  =<span class="pyc2"> ctx.quantumCircuit.go(shift_left[i]) </span></span><br>
            <span style="margin-left:90px">gradient = torch.tensor([right]) - torch.tensor([left])</span><br>
            <span style="margin-left:90px">gradients.append(gradient)</span><br>
            <span style="margin-left:60px">gradients = np.array([gradients]).T</span><br>
        <span style="margin-left:60px">return torch.tensor([gradients]).float() * output.float(), None, None</span><br>

        <br><br>
</div>

Qui di definisce la class myQNN che partendo da nn.Module di PyTorch ci permette di definire un nuovo layer 
da inserire poi nel Neural Network e farà da collante tra il NN ed il circuito quantistico tramite il metodo 
forward dove la class myFunction con il metodo apply verrà chiamata in esecuzione direttamente. 


<div class="model">       
    <span class="pyc">class  </span> myQNN(nn.Module):<br>
<span style="margin-left:30px"> """ define layer per unire NN con Quantum circuit """</span><br>
    
<span style="margin-left:30px"> <span class="pyc">def </span> __init__(self, backend, shots, shift):</span><br>
<span style="margin-left:60px">super(myQNN, self).__init__()</span><br>
<span style="margin-left:60px">self.quantumCircuit = Circuit(1, backend, shots)</span><br>
<span style="margin-left:60px">self.shift = shift</span><br>
        
<span style="margin-left:30px"> <span class="pyc">def </span> forward(self, input):</span><br>
<span style="margin-left:60px">return <span class="pyc2">myFunction.apply(input, self.quantumCircuit, self.shift)</span></span><br>
</div>


Veniamo ora alla definizione della class NN cioè del Neural Network e nello specifico della Convolutional 
Neural Network.<br> Di per se è una classica definizione ma l'ultimo layer inserito chiama la class 
myQnn che come accennato prima lancia in automatico il circuito quantistico. 

<div class="model">
    <span class="pyc">class </span> NN(nn.Module):<br>
<span style="margin-left:30px"> <span class="pyc">def</span>  __init__(self):</span><br>
        <span style="margin-left:60px">super(NN, self).__init__()</span><br>
        <span style="margin-left:60px">self.conv1 = nn.Conv2d(1, 6, kernel_size=5)</span><br>
        <span style="margin-left:60px">self.conv2 = nn.Conv2d(6, 16, kernel_size=5)</span><br>
        <span style="margin-left:60px">self.dropout = nn.Dropout2d()</span><br>
        <span style="margin-left:60px">self.fc1 = nn.Linear(256, 64)</span><br>
        <span style="margin-left:60px">self.fc2 = nn.Linear(64, 1)</span><br>
        <span style="margin-left:60px">self.myQNN =<span class="pyc2"> myQNN(Aer.get_backend('qasm_simulator'), 1000, np.pi / 2)</span> </span><br>
            
        <span style="margin-left:30px"> <span class="pyc">def </span> forward(self, x):</span><br>
        <span style="margin-left:60px">x = F.relu(self.conv1(x))</span><br>
        <span style="margin-left:60px"> x = F.max_pool2d(x,2)</span><br>
        <span style="margin-left:60px"> x = F.relu(self.conv2(x))</span><br>
        <span style="margin-left:60px">x = F.max_pool2d(x,2)</span><br>
        <span style="margin-left:60px">x = self.dropout(x)</span><br>
        <span style="margin-left:60px">x = x.view(1, -1)</span><br>
        <span style="margin-left:60px">x = F.relu(self.fc1(x))</span><br>
        <span style="margin-left:60px">x = self.fc2(x)</span><br>
        <span style="margin-left:60px">x =<span class="pyc2"> self.myQNN(x)</span> </span><br>
        <span style="margin-left:60px"> return torch.cat((x, 1 - x), -1)</span><br>
        <br><br>
</div>

Definiamo ora alcumi hyperparameter come il learning rate(% apprendimento), epochs(iterazioni del NN) e momentum per il 
gradients e istanziamo il NN e definiamo il tipo di optimizer con i relativi parametri. 


<div class="model">
EPOCHS = 4<br>
learning_rate = 0.02<br>
momentum=0.5<br>
model = NN()<br>
optimizer = <span class="pyc2">optim.SGD</span>(model.parameters(), lr=learning_rate,<br>
            momentum=momentum)</span><br>
</div>
 
<div class="grover">
   <br>
MODELLO CNN CREATO <br><br>
<br><br>
NN(<br>
  (conv1): Conv2d(1, 6, kernel_size=(5, 5), stride=(1, 1))<br>
  (conv2): Conv2d(6, 16, kernel_size=(5, 5), stride=(1, 1))<br>
  (dropout): Dropout2d(p=0.5, inplace=False)<br>
  (fc1): Linear(in_features=256, out_features=64, bias=True)<br>
  (fc2): Linear(in_features=64, out_features=1, bias=True)<br>
  (myQNN): myQNN()<br>
)<br>

</div>

Sotto procediamo tramite delle utility fornite da PyTorch ad estrarre un archivio di immgini di hanwritten, 
numeri da 0 a 9 forniti per effettuare queste prove. 
Creiamo un archivio x_train per creare il modello ed un archivio x_test per poi fare la verifica 
della bontà del modello creato. Prendiamo solo gli zeri e gli uno. 

 <div class="model">
x_train = datasets.MNIST(root='./data', train=True, download=True,<br>
<span style="margin-left:120px"> transform=transforms.Compose([transforms.ToTensor()]))</span><br>

i = np.append(np.where(x_train.targets == 0)[0], np.where(x_train.targets == 1)[0])<br>

x_train.data = x_train.data[i]<br>
x_train.targets = x_train.targets[i]<br>

x_train = torch.utils.data.DataLoader(x_train, batch_size=1, shuffle=True)<br>



x_test = datasets.MNIST(root='./data', train=True, download=True,<br>
<span style="margin-left:120px"> transform=transforms.Compose([transforms.ToTensor()]))</span><br>

i = np.append(np.where(x_test.targets == 0)[0], np.where(x_test.targets == 1)[0])<br>

x_test.data = x_test.data[i]<br>
x_test.targets = x_test.targets[i]<br>

x_test = torch.utils.data.DataLoader(x_test, batch_size=1, shuffle=True)<br>
 </div>

Con la funtion train passiamo al momento in cui lanciamo il NN per creare alla fine del training il modello.
<br>Qui definiamo prima i contenitori dove inserire le variabili e poi iniziamo ad estrarre i dati delle immagini e le inseriamo 
nel model per avere i primi dati e ad ogni iterazione vengono aggiornati i dati dell'optimizer e della 
loss function.<br>
Al termine della iterazione abbiamo il modello che poi testeremo inserendo delle immagini e si vedrà 
se il risultato ottenuto è uguale al dato reale. 

<div class="model">

    <span class="pyc">def </span> train(epoch):<br>
<span style="margin-left:30px"> count =  []</span><br>
            <span style="margin-left:30px"> losses= []</span><br>
            <span style="margin-left:30px"> previsioneOk = 0</span><br>
            <span style="margin-left:30px"> <span class="pyc2"> model.train()</span></span><br>
            <span style="margin-left:30px"> for index, (x, y) in enumerate(x_train):</span><br>
            <span style="margin-left:60px"> <span class="pyc2">optimizer.zero_grad()</span></span><br>
                <span style="margin-left:60px"> <span class="pyc2">prevModel = model(x) </span></span><br>
                <span style="margin-left:60px"> loss =<span class="pyc2"> F.nll_loss(prevModel, y)</span></span><br>
                <span style="margin-left:60px"> <span class="pyc2">loss.backward()</span></span><br>
                <span style="margin-left:60px"> <span class="pyc2">optimizer.step()</span> </span><br>
                <span style="margin-left:60px"> pred = prevModel.data.max(1, keepdim=True)[1]</span><br>
                <span style="margin-left:60px">previsioneOk += pred.eq(y.data.view_as(pred)).sum()</span><br>
              
          
                <span style="margin-left:60px">if index % 1000 == 0:</span><br>
                
                <span style="margin-left:90px">print(f'Train Epoch: {epoch} images {index * len(x)}/{len(x_train.dataset) } % </span><br>
                <span style="margin-left:90px">{ 100. * index / len(x_train) :.2f} loss {loss.item()}  previsione corretta </span><br>
                <span style="margin-left:90px">{ 100. * previsioneOk / len(x_train):.2f}')</span><br>
                <span style="margin-left:90px"> losses.append(loss.item())</span><br>
                <span style="margin-left:90px">count.append(</span><br>
                <span style="margin-left:90px">(index*64) + ((epoch-1)*len(x_train.dataset)))</span><br>
                <span style="margin-left:60px">print(f'Train Epoch: {epoch} images {index * len(x)}/{len(x_train.dataset) } % </span><br>
                <span style="margin-left:60px">  { 100. * index / len(x_train) :.2f} loss {loss.item()}  accuracy </span><br>
                <span style="margin-left:60px"> { 100. * previsioneOk / len(x_train):.2f}')</span><br>
                <br><br>

</div>
Costruito il modello passiamo ora ad inserire le stesse immagini con cui il modello 
è stato costruito e vediamo la percentuale di correttezza delle previsioni effettuate. 


<div class="model">
   <span class="pyc">def </span> test():<br>
<span style="margin-left:30px"> model.eval()</span><br>
 <span style="margin-left:30px"> testLoss = 0</span><br>
 <span style="margin-left:30px">totTestLoss = []</span><br>
 <span style="margin-left:30px">previsioneOk = 0</span><br>
 <span style="margin-left:30px"> with torch.no_grad() :</span><br>
 <span style="margin-left:60px"> for index, (x, y) in enumerate(x_test):</span><br>
 <span style="margin-left:90px">prevModel = model(x)</span><br>
 <span style="margin-left:90px">testLoss += F.nll_loss(prevModel, y, size_average=False).item()</span><br>
  <span style="margin-left:90px"> pred = prevModel.data.max(1, keepdim=True)[1]</span><br>
  <span style="margin-left:90px"> previsioneOk += pred.eq(y.data.view_as(pred)).sum()</span><br>
  <span style="margin-left:90px"> testLoss /= len(x_test.dataset)</span><br>
 <span style="margin-left:90px">totTestLoss.append(testLoss)</span><br>
   <span style="margin-left:90px"> if index % 1000 == 0:</span><br>
   <span style="margin-left:120px">print('\nTest: Avg. loss: {:.8f}, Accuracy: {}/{} ({:.0f}%)\n'.format(</span><br>
   <span style="margin-left:120px">testLoss, previsioneOk, len(x_test.dataset),  100. * previsioneOk / len(x_test.dataset)))</span><br>
 <span style="margin-left:60px">   print(f' loss {testLoss }  previsione corretta { 100. * previsioneOk / len(x_test):.2f}') </span><br>

 <br><br>


for epoch in range(1, EPOCHS + 1):<br>
<span style="margin-left:60px">train(epoch)</span><br>
   <br> <br> <br>
   Risultato fase di training<br>
   Train Epoch: 4 images 12664/12665 % 99.99 loss -0.996  accuracy 99.96 %<br><br>
test()<br> <br> <br>
Risultato fase di testing<br><br>
loss -7.856916622352382e-05  previsione corretta 99.98 %<br>
<br><br>

n = 0<br>
fig, axes = plt.subplots(nrows=1, ncols=10, sharex=True, figsize=(15, 3))<br>
for x, y in x_test:<br>
<span style="margin-left:60px"> if n == 10:</span><br>
<span style="margin-left:90px">  break</span><br>
<span style="margin-left:60px"> prevModel = model(x)</span><br>
        
<span style="margin-left:60px"> pred = prevModel.argmax(dim=1, keepdim=True) </span><br>
      
<span style="margin-left:60px"> axes[n].imshow(x[0].numpy().squeeze())</span><br>
<span style="margin-left:60px"> axes[n].set_xticks([])</span><br>
<span style="margin-left:60px"> axes[n].set_yticks([])</span><br>
<span style="margin-left:60px"> axes[n].set_title(f'PreV  { pred.item()}')</span><br>
<span style="margin-left:60px">  n +=1</span><br>


</div>
<br><br>
<img src="foto/qcnnris.png" width="100%" height="100px">





</div>








</body>
</html>
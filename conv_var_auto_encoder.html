<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0" />
    <meta name="google-site-verification" content="VXixwtxrf--qUV1swfStEg9jOGPKgUm6C3Ub_vouqmc" />
    <title>MecBar | The Mec Evolution </title>
    <link rel="icon" href="foto/favicon.ico"/>
    <!-- CSS  -->
    <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection" />
    
    <script src="js/jquery-3.js"></script>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
   
    <link href="https://fonts.googleapis.com/css?family=Raleway|Satisfy" rel="stylesheet">
   

    <link href="css/style2.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link href="css/navbar.css" type="text/css" rel="stylesheet" media="screen,projection" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital@1&display=swap" rel="stylesheet"> 
</head>
<header>
    <nav>
        <li class="nav-wrapper back-home" id="head">
            <a href="http://www.mecbar.com/" class="brand-logo mecbar">
                <?xml version="1.0" encoding="UTF-8" standalone="no"?>
                <svg
                   xmlns:osb="http://www.openswatchbook.org/uri/2009/osb"
                   xmlns:dc="http://purl.org/dc/elements/1.1/"
                   xmlns:cc="http://creativecommons.org/ns#"
                   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                   xmlns:svg="http://www.w3.org/2000/svg"
                   xmlns="http://www.w3.org/2000/svg"
                   xmlns:xlink="http://www.w3.org/1999/xlink"
                   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
                   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
                   width="156"
                   height="64"
                   viewBox="0 0 12.3825 5.08"
                   version="1.1"
                   id="svg8"
                   inkscape:version="1.0 (6e3e5246a0, 2020-05-07)"
                   sodipodi:docname="mecbar.svg">
                  <defs
                     id="defs2">
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient2948">
                      <stop
                         id="stop2946"
                         offset="0"
                         style="stop-color:#c6126a;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       osb:paint="solid"
                       id="linearGradient875">
                      <stop
                         id="stop873"
                         offset="0"
                         style="stop-color:#babd06;stop-opacity:1;" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3253"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#878734;stop-opacity:1;"
                         offset="0"
                         id="stop3251" />
                    </linearGradient>
                    <linearGradient
                       inkscape:collect="always"
                       id="linearGradient3093">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3089" />
                      <stop
                         style="stop-color:#c6126a;stop-opacity:0;"
                         offset="1"
                         id="stop3091" />
                    </linearGradient>
                    <linearGradient
                       id="linearGradient3071"
                       osb:paint="solid">
                      <stop
                         style="stop-color:#c6126a;stop-opacity:1;"
                         offset="0"
                         id="stop3069" />
                    </linearGradient>
                    <rect
                       x="38.182308"
                       y="80.104469"
                       width="51.135052"
                       height="30.274338"
                       id="rect18630" />
                    <rect
                       x="160.31746"
                       y="77.487633"
                       width="134.35785"
                       height="60.829021"
                       id="rect18624" />
                    <rect
                       x="70.354279"
                       y="28.223705"
                       width="103.27115"
                       height="64.638908"
                       id="rect18618" />
                    <rect
                       x="32.55666"
                       y="25.199898"
                       width="5.2916665"
                       height="43.089287"
                       id="rect18612" />
                    <rect
                       x="34.029621"
                       y="65.792862"
                       width="93.441322"
                       height="26.673161"
                       id="rect18606" />
                    <rect
                       x="10.284417"
                       y="19.486744"
                       width="193.27823"
                       height="129.88597"
                       id="rect18596" />
                    <linearGradient
                       inkscape:collect="always"
                       xlink:href="#linearGradient3093"
                       id="linearGradient3101"
                       gradientUnits="userSpaceOnUse"
                       x1="3.1346149"
                       y1="23.792595"
                       x2="78.606865"
                       y2="23.792595" />
                    <filter
                       height="1"
                       y="-2.5183475e-16"
                       width="1"
                       x="-7.1910066e-17"
                       style="color-interpolation-filters:sRGB"
                       inkscape:label="Blend"
                       id="filter3198">
                      <feBlend
                         in2="SourceGraphic"
                         mode="multiply"
                         result="fbSourceGraphic"
                         id="feBlend3196" />
                      <feColorMatrix
                         result="fbSourceGraphicAlpha"
                         in="fbSourceGraphic"
                         values="0 0 0 -1 0 0 0 0 -1 0 0 0 0 -1 0 0 0 0 1 0"
                         id="feColorMatrix3200" />
                      <feBlend
                         in2="fbSourceGraphic"
                         id="feBlend3202"
                         mode="multiply"
                         result="blend"
                         in="fbSourceGraphic" />
                      <feGaussianBlur
                         id="feGaussianBlur869"
                         stdDeviation="6.7542215e-15" />
                    </filter>
                    <linearGradient
                       gradientUnits="userSpaceOnUse"
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       id="linearGradient2950"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                    <linearGradient
                       y2="9.1505461"
                       x2="228.5569"
                       y1="9.1505461"
                       x1="3.1346149"
                       gradientTransform="translate(2.3455617,-9.683066)"
                       gradientUnits="userSpaceOnUse"
                       id="linearGradient3064"
                       xlink:href="#linearGradient2948"
                       inkscape:collect="always" />
                  </defs>
                  <sodipodi:namedview
                     id="base"
                     pagecolor="#ffffff"
                     bordercolor="#666666"
                     borderopacity="1.0"
                     inkscape:pageopacity="0.0"
                     inkscape:pageshadow="2"
                     inkscape:zoom="0.7"
                     inkscape:cx="355.19772"
                     inkscape:cy="45.714286"
                     inkscape:document-units="mm"
                     inkscape:current-layer="layer1-6"
                     inkscape:document-rotation="0"
                     showgrid="false"
                     inkscape:window-width="1324"
                     inkscape:window-height="747"
                     inkscape:window-x="36"
                     inkscape:window-y="21"
                     inkscape:window-maximized="1"
                     units="px"
                     inkscape:snap-nodes="true"
                     inkscape:object-paths="true"
                     scale-x="0.3" />
                  <metadata
                     id="metadata5">
                    <rdf:RDF>
                      <cc:Work
                         rdf:about="">
                        <dc:format>image/svg+xml</dc:format>
                        <dc:type
                           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                        <dc:title></dc:title>
                      </cc:Work>
                    </rdf:RDF>
                  </metadata>
                  <g
                     inkscape:label="Layer 1"
                     inkscape:groupmode="layer"
                     class="io"
                     id="layer1">
                    <rect
                       ry="7.1295023"
                       rx="10.726023"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="21.245117"
                       width="20.103241"
                       id="rect2824"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                    <g
                       inkscape:label="Layer 1"
                       id="layer1-6"
                       transform="matrix(0.16152221,0.0020121,0,0.13626925,0.08059628,0.86541284)"
                       style="mix-blend-mode:normal;fill:url(#linearGradient2950);fill-opacity:1;stroke-width:6.74038;filter:url(#filter3198);image-rendering:optimizeQuality">
                      <text
                         xml:space="preserve"
                         id="text18594"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18596);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;line-height:125%;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;letter-spacing:0px;word-spacing:0px;fill:url(#linearGradient3064);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                         x="-4.0898471"
                         y="24.876211"
                         id="text18602"
                         transform="matrix(0.75566848,-0.20637119,0.34609071,1.2288151,0,0)"><tspan
                   sodipodi:role="line"
                   id="tspan18600"
                   x="-4.0898471"
                   y="24.876211"
                   style="font-style:oblique;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:25.0978px;font-family:Purisa;-inkscape-font-specification:'Purisa, Oblique';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:url(#linearGradient3064);fill-opacity:1;stroke-width:1.78339px">MecBar</tspan>        <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="0s;light_2.end"
                   dur="1s"
                   values="1;0"
                   attributeName="fill-opacity"
                   id="light_1" />       <animate
                   style="fill-opacity:1;fill:url(#linearGradient3064)"
                   begin="light_1.end"
                   dur="1s"
                   values="0;1"
                   attributeName="fill-opacity"
                   id="light_2" />           </text>
                      <text
                         xml:space="preserve"
                         id="text18604"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18606);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18610"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18612);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18616"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18618);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18622"
                         style="font-style:normal;font-weight:normal;font-size:10.5833px;line-height:125%;font-family:sans-serif;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18624);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <text
                         xml:space="preserve"
                         id="text18628"
                         style="font-style:normal;font-weight:normal;font-size:12.7px;line-height:125%;font-family:sans-serif;text-align:justify;letter-spacing:0px;word-spacing:0px;white-space:pre;shape-inside:url(#rect18630);fill:url(#linearGradient2950);fill-opacity:1;stroke:none;stroke-width:1.78339px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1;" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="0s;light_2.end"
                         dur="1s"
                         values="1;0"
                         attributeName="fill-opacity"
                         id="light_1" />
                      <animate
                         style="fill-opacity:1;fill:url(#linearGradient2950)"
                         begin="light_1.end"
                         dur="1s"
                         values="0;1"
                         attributeName="fill-opacity"
                         id="light_2" />
                    </g>
                    <rect
                       ry="7.1295042"
                       rx="10.726021"
                       y="-2.8428149"
                       x="-4.4855061"
                       height="16.413473"
                       width="25.987757"
                       id="rect871"
                       style="opacity:0;fill:#c6126a;stroke:#babd06;stroke-width:0.0794996;stroke-opacity:0.00424254" />
                  </g>
                  <style
                     id="style43">
                           #tspan18600 {
                               
                              animation-name: mecOpacity;
                              animation-duration: 2s;
                              animation-iteration-count: infinite;
                              }
                              @keyframes mecOpacity {
                              0%   { fill-opacity:1 }
                                50%  {fill-opacity :0.1; }
                            100% { fill-opacity: 1; }
                              }
                    </style>
                </svg>
                </a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>

            <ul class="right hide-on-med-and-down">
                <!--  <li> <a class="btn" onclick="Materialize.toast('Hello', 4000, 'Ciao' ,4000 )">Touch Me</a> </li>
              -->

              <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
              <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Windows">Windows</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
                <li>
                    <a href=""> </a>
                </li>
                <li>
                    <a href=""> </a>
                </li>
            </ul>
          
              <ul class="side-nav" id="mobile-demo">
               <li><a href="http://www.mecbar.com/#Ablog">Blog</a></li>
              <li><a href="http://www.mecbar.com/#Ablock">Blockchain</a></li>
                 <li><a href="http://www.mecbar.com/#quantum">Quantum</a></li>
              <li><a href="http://www.mecbar.com/#Amachine">Machine Learning</a></li>
              <li><a href="http://www.mecbar.com/#Windows">Windows</a></li>
              <li><a href="http://www.mecbar.com/#Alinux">Linux</a></li>
              <li><a href="http://www.mecbar.com/#Aus">Contatti</a></li>
            </ul>
        
            </li>
    </nav>
</header>
<style>
    .tasto-su {
            position: fixed;
            bottom: 15px;
            right: 5px;
            padding: 8px;
            background: rgb(6, 29, 160);
            color: white;
            border-radius: 20px;
            display:block;
            cursor: pointer;
            z-index: 5;
        }
   .tasto-su:hover {
            background:rgb(24, 2, 122);
            color :rgb(251, 173, 25);
        }

</style>

<body>
<div class="center titolo">
    <i>Convolutional Variational AutoEncoder - cVAE   </i>
 </div>
 <div class="testo">
Tramite un modello di AutoEncoder(Encoder - Decoder) usando la <a href="convolutionalNeuralNetwork.html">CNN(Convolutional 
Neural Network)</a> si possono creare delle immagini nuove che non esistono nella realtà come con il modello GAN.
<br><br>
<div class="row">
<div class="col l2 m2 s2"></div>
<div class="col l8 m8 s12">
<img  src="foto/autoencodergra.png" width="100%" height="300px">
</div>
<div class="col l2 m2 s2"></div>
</div>
<br>
Nel dettaglio vedremo la creazione di 2 modelli un Encoder che riduce le dimensioni dei dati inseriti ed un Decoder che 
ricrea l'immagine inserita. Tra i 2 modelli si inserisce dei layer full connected che prende il latent space
z che deriva dall'encoder che poi sarà l'input del decoder che non cercherà di ricreare fedelmente l'immagine inserita in input ma ne creerà 
una differente che prima non esisteva.
L'input di questo modello sono delle immagini di celebrità che dopo essere state scaricate vengono 
trasformate nel formato 64x64 e con il dataloader inserite in dataset iterabili in base al batch size definito. 

Sotto il codice relativo all'import dei moduli necessari e la creazione del dataset sopra indicato. 
 </div>
<div class="dot">
import os<br>
import tarfile<br>-
!pip install mxnet<br>
from mxnet.gluon import utils<br>
import torch<br>
import torchvision<br>
import torch.nn as nn<br>
import torch.nn.functional as F<br>
import torchvision.datasets as dset<br>
from torchvision import transforms<br>
from torchvision.datasets import ImageFolder<br>
from torchvision.utils import save_image<br>
from torchvision.utils import make_grid<br>
from torch.autograd import Variable<br>
from torch.utils.data import DataLoader, Dataset<br>
import matplotlib.pyplot as plt<br>
import numpy as np<br>
import torchvision.utils as vutils<br>
import joblib<br>
from PIL import Image<br>
import shutil<br>
#from ray import tune<br>
#from ray.tune import CLIReporter<br>
#from ray.tune.schedulers import ASHAScheduler<br>
from torch.utils.tensorboard import SummaryWriter<br>
writer = SummaryWriter('TensorBoard/dcGan')<br>
%matplotlib inline<br>
<br><br>
</div>
<span class="testo dot1">Definizione hyperparameter</span>
<div class="dot">
kernel_size = 3<br>
stride = 2<br>
padding = 2<br>
channels = 64 # initial number of filters<br>
color = 3  # 3 color 1 b/n<br>
latent_dim = 100<br>
<br>
torch.manual_seed(125)<br>
batch_size = 128<br>
lr = 0.002<br>
<br>
# select device CPU o GPU <br>
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')<br>
<br>
</div>
<span class="testo dot1">Download, estrazione e creazione dataloader delle immagini</span>
<div class="dot">
lfw_url = 'http://vis-www.cs.umass.edu/lfw/lfw-deepfunneled.tgz'<br>
root = 'lfw_dataset'<br>
if not os.path.exists(root):<br>
<span style="margin-left:30px">os.makedirs(root)</span><br>
<span style="margin-left:30px"> data_file = utils.download(lfw_url)</span><br>
 <span style="margin-left:30px"> with tarfile.open(data_file) as tar:</span><br>
  <span style="margin-left:60px">tar.extractall(path=root)</span><br>
 <br>

dest = 'lfw'<br>
<br>
if not os.path.exists(dest):<br>
<span style="margin-left:30px">os.makedirs(dest)</span><br>

    <br>
for path, _, files in os.walk(root):<br>
    
<span style="margin-left:30px">for file in files:</span><br>
        
  <span style="margin-left:60px">if file :</span><br>
 <span style="margin-left:90px">shutil.copy(path + '/'+ file, '/content/lfw')</span><br>

  <span style="margin-left:90px">root = '/content/'</span><br>
 <span style="margin-left:90px"> my_dataset = dset.ImageFolder(root= root,</span><br>
 <span style="margin-left:120px"> transform=transforms.Compose([</span><br>
 <span style="margin-left:120px">transforms.Resize(64),</span><br>
 <span style="margin-left:120px">transforms.CenterCrop(64),</span><br>
<span style="margin-left:120px">transforms.ToTensor(),</span><br>
 <span style="margin-left:120px">transforms.Normalize((0.5, 0.5, 0.5), (0.5, 0.5, 0.5)),</span><br>
  <span style="margin-left:120px">]))</span><br>
 <span style="margin-left:90px"># Create the dataloader</span><br>
<span style="margin-left:90px"> train_data  = DataLoader(my_dataset, batch_size=batch_size,</span><br>
 <span style="margin-left:120px">shuffle=True, num_workers=4, drop_last= True)</span><br>
</div>

<span class="testo dot1">
Vediamo alcuni esempi delle imagini di celebrità che vengono usate per creare il modello.</span><br>


<br><br>
<img  src="foto/lfw_celeb.png" width="100%" height="350px">
<br><br>
<span class="testo dot1">Definizione oggetto che contiene i 2 modelli, l'Encoder ed il Decoder </span><br>

<div class="dot">
# define class for Convolutional VAE<br><br>

<span class="dot1">class myConVAE</span>(nn.Module):<br><br>

<span style="margin-left:30px"><span class="dot1">def __init__</span>(self):</span><br>
   
<span style="margin-left:60px"># encoder</span><br>
 <span style="margin-left:60px"> self.encoder1 = nn.Conv2d(</span><br>
 <span style="margin-left:90px">in_channels=color, out_channels=channels, kernel_size=kernel_size, stride=stride, padding=padding )</span><br>
<span style="margin-left:60px">self.bn1 = nn.BatchNorm2d(channels)</span><br>
 <span style="margin-left:60px"> self.encoder2 = nn.Conv2d(</span><br>
 <span style="margin-left:90px">in_channels=channels, out_channels=channels*2, kernel_size=kernel_size, stride=stride, padding=padding )</span><br>
 <span style="margin-left:60px">self.bn2 = nn.BatchNorm2d(channels*2)</span><br>
  <span style="margin-left:60px">self.encoder3 = nn.Conv2d(</span><br>
  <span style="margin-left:90px">in_channels=channels*2, out_channels=channels*4, kernel_size=kernel_size, stride=stride, padding=padding )</span><br>
 <span style="margin-left:60px"> self.bn3 = nn.BatchNorm2d(channels*4)</span><br>
 <span style="margin-left:60px">self.encoder4 = nn.Conv2d(</span><br>
  <span style="margin-left:90px"> in_channels=channels*4, out_channels=channels*8, kernel_size=kernel_size, stride=stride, padding=padding )</span><br>
 <span style="margin-left:60px">self.bn4 = nn.BatchNorm2d(channels*8)</span><br>
 <span style="margin-left:60px">self.encoder5 = nn.Conv2d(</span><br>
 <span style="margin-left:90px">in_channels=channels*8, out_channels=channels*16, kernel_size=kernel_size, stride=stride, padding=padding )</span><br>
 <span style="margin-left:60px">self.bn5 = nn.BatchNorm2d(channels*16)</span><br>
 <br>

  <span style="margin-left:60px"> # full connect layer</span><br>

<span style="margin-left:60px"> self.fc1 = nn.Linear(1024, 2048)    # 1024 = channels * 16 </span><br>
 <span style="margin-left:60px"> self.fcMean = nn.Linear(2048, latent_dim)</span><br>
  <span style="margin-left:60px">self.fcLog_var = nn.Linear(2048, latent_dim)</span><br>
<span style="margin-left:60px"> self.fc2 = nn.Linear(latent_dim, 1024)</span><br>

<br>
 <span style="margin-left:60px"> # decoder </span><br>
<span style="margin-left:60px">self.decoder1 = nn.ConvTranspose2d(</span><br>
 <span style="margin-left:90px">in_channels=channels*16, out_channels=channels*8, kernel_size=kernel_size, stride=stride )</span><br>
  <span style="margin-left:60px">self.bn6 = nn.BatchNorm2d(channels*8)</span><br>
 <span style="margin-left:60px">self.decoder2 = nn.ConvTranspose2d(</span><br>
 <span style="margin-left:90px">in_channels=channels*8, out_channels=channels*4, kernel_size=kernel_size, stride=stride )</span><br>
 <span style="margin-left:60px"> self.bn7 = nn.BatchNorm2d(channels*4)</span><br>
 <span style="margin-left:60px"> self.decoder3 = nn.ConvTranspose2d(</span><br>
<span style="margin-left:90px"> in_channels=channels*4, out_channels=channels*2, kernel_size=kernel_size, stride=stride )</span><br>
 <span style="margin-left:60px">self.bn8 = nn.BatchNorm2d(channels*2)</span><br>
 <span style="margin-left:60px"> self.decoder4 = nn.ConvTranspose2d(</span><br>
 <span style="margin-left:90px">in_channels=channels*2, out_channels=channels, kernel_size=kernel_size, stride=stride )</span><br>
 <span style="margin-left:60px"> self.bn9 = nn.BatchNorm2d(channels)</span><br>
 <span style="margin-left:60px">self.decoder5 = nn.ConvTranspose2d(</span><br>
 <span style="margin-left:90px">in_channels=channels, out_channels=color, kernel_size=4, stride=stride )</span><br>
   
 <br>
 <span style="margin-left:30px"><span class="dot1">def encoder</span>(self, x):</span><br>

<span style="margin-left:60px"># encoder</span><br>
<span style="margin-left:60px"> x = F.relu(self.bn1(self.encoder1(x)))</span><br>
 <span style="margin-left:60px"> x = F.relu(self.bn2(self.encoder2(x)))</span><br>
 <span style="margin-left:60px">x = F.relu(self.bn3(self.encoder3(x)))</span><br>
 <span style="margin-left:60px"> x = F.relu(self.bn4(self.encoder4(x)))</span><br>
 <span style="margin-left:60px">x = F.relu(self.bn5(self.encoder5(x)))</span><br>
 <span style="margin-left:60px"> x = F.adaptive_max_pool2d(x, 1)  # adaptive maxpooling</span><br>
<span style="margin-left:60px"> x = x.reshape(batch_size,-1)  # reshape for input into full connected layer</span><br>
<span style="margin-left:60px">return x</span><br>
<br>
    <span style="margin-left:30px"><span class="dot1">def decoder</span>(self, x):</span><br>
<span style="margin-left:60px"># decoder</span><br>
<span style="margin-left:60px">x = F.relu(self.bn6(self.decoder1(x)))</span><br>
 <span style="margin-left:60px">x = F.relu(self.bn7(self.decoder2(x)))</span><br>
 <span style="margin-left:60px">x = F.relu(self.bn8(self.decoder3(x)))</span><br>
 <span style="margin-left:60px">x = F.relu(self.bn9(self.decoder4(x)))</span><br>
 <span style="margin-left:60px">x = torch.sigmoid(self.decoder5(x))</span><br>
<span style="margin-left:60px">return x</span><br>
<br>
<span style="margin-left:30px"><span class="dot1">def crea</span>(self, x):</span><br>
<span style="margin-left:60px"># input encoder</span><br>
 <span style="margin-left:60px">x = self.decoder(x)</span><br>
<span style="margin-left:60px">return x</span><br>
<br>
<span style="margin-left:30px"><span class="dot1">def forward</span>(self, x):</span><br>
 <span style="margin-left:60px">enc = self.encoder(x)</span><br>

 <span style="margin-left:60px">hidden_layer  = self.fc1(enc)</span><br>

 <span style="margin-left:60px"> mean_lv = self.fcMean(hidden_layer) </span><br>
 <span style="margin-left:60px">log_var =  self.fcLog_var(hidden_layer) </span><br>

 <span style="margin-left:60px"># mean_lv -- log_variance -- for get latent Z </span><br>
 <span style="margin-left:60px">std_dev = torch.exp(0.5*log_var) # standard deviation</span><br>
 <span style="margin-left:60px"> random_space = torch.randn_like(std_dev) # get random tensor with same size std_dev</span><br>
 <span style="margin-left:60px"> # latent space vector </span><br>
<span style="margin-left:60px">latent_space_z = mean_lv + (random_space * std_dev)</span><br>

 <span style="margin-left:60px"> latent_space_z = self.fc2(latent_space_z)</span><br>
<span style="margin-left:60px">latent_space_z = latent_space_z.view(enc.shape[0],enc.shape[1], 1, 1)</span><br>
<span style="margin-left:60px">out = self.decoder(latent_space_z)</span><br>
        
<span style="margin-left:60px"> return out , mean_lv, log_var</span><br>
 </div>
 <span class="testo dot1">Istanza dell'oggetto ed assegnazione optimizer e loss function</span>
 <div class="dot"> 
history_loss = []<br>
<br>
convae = myConVAE().to(device)<br>
optimizer = torch.optim.Adam(convae.parameters(), lr=lr)<br>
lossF = nn.BCELoss(reduction='sum')<br>

 </div>
 <span class="testo dot1">Esecuzione della fase train per creare modello </span>

 <div class="dot">
convae.train()<br>
num_epochs = 100<br>
for epoch in range(num_epochs):<br>
<span style="margin-left:30px">for n_train, data in enumerate(train_data, 0):</span><br>
 <span style="margin-left:60px"> x_train = data[0].to(device)</span><br>

 <span style="margin-left:60px">optimizer.zero_grad()</span><br>
<span style="margin-left:60px">recreated_image, mean_lv, log_variance_lv = convae(x_train)</span><br>

<span style="margin-left:60px">bceLoss = lossF(recreated_image.to(device), x_train)  # calculate loss from real image and recreated image</span><br>
<span style="margin-left:60px"># KLD is KL-Divergence = "0.5 * sum(1 + log(sigma^2) - mean_lv^2 - sigma^2)"</span><br>
 <span style="margin-left:60px"> KLD = -0.5 * torch.sum(1 + log_variance_lv - mean_lv.pow(2) - log_variance_lv.exp())</span><br>
      
 <span style="margin-left:60px">lossKD = bceLoss + KLD   # complesse loss (loss BCE + KLD)   </span><br> 
 <span style="margin-left:60px">lossKD.backward()</span><br>
  <span style="margin-left:60px">history_loss.append(lossKD.item())</span><br>
  <span style="margin-left:60px">optimizer.step()</span><br>
        
<span style="margin-left:60px"> if n_train + 1 == len(train_data) :</span><br>
            
 <span style="margin-left:90px"> #salvaCheckpoint()</span><br>
 <span style="margin-left:90px"> print(f"Epoch: {epoch} bce Loss : {bceLoss: 3f}", f"KLD loss : {KLD: 3f}")</span><br>
 </div>

 <span class="testo dot1">Display del Modello </span>            
            
<div class="dot">
   <span class="dot1"> myConVAE(</span><br>
                            (encoder1): Conv2d(3, 64, kernel_size=(3, 3), stride=(2, 2), padding=(2, 2))<br>
                            (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (encoder2): Conv2d(64, 128, kernel_size=(3, 3), stride=(2, 2), padding=(2, 2))<br>
                            (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (encoder3): Conv2d(128, 256, kernel_size=(3, 3), stride=(2, 2), padding=(2, 2))<br>
                            (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (encoder4): Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(2, 2))<br>
                            (bn4): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (encoder5): Conv2d(512, 1024, kernel_size=(3, 3), stride=(2, 2), padding=(2, 2))<br>
                            (bn5): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                    <br>       
                            (fc1): Linear(in_features=1024, out_features=2048, bias=True)<br>
                            (fcMean): Linear(in_features=2048, out_features=100, bias=True)<br>
                            (fcLog_var): Linear(in_features=2048, out_features=100, bias=True)<br>
                            (fc2): Linear(in_features=100, out_features=1024, bias=True)<br>
<br>     
                            (decoder1): ConvTranspose2d(1024, 512, kernel_size=(3, 3), stride=(2, 2))<br>
                            (bn6): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (decoder2): ConvTranspose2d(512, 256, kernel_size=(3, 3), stride=(2, 2))<br>
                            (bn7): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (decoder3): ConvTranspose2d(256, 128, kernel_size=(3, 3), stride=(2, 2))<br>
                            (bn8): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (decoder4): ConvTranspose2d(128, 64, kernel_size=(3, 3), stride=(2, 2))<br>
                            (bn9): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)<br>
                            (decoder5): ConvTranspose2d(64, 3, kernel_size=(4, 4), stride=(2, 2))<br>
                          )   <br>
</div>
      
<span class="testo dot1">Display dell'andamento loss function </span>
<div class="dot">
plt.figure(figsize=(12,7))<br>
plt.title("Loss Training")<br>
plt.plot(history_loss,label="Total Loss")<br>
plt.xlabel("iterations")<br>
plt.ylabel("Loss")<br>
plt.legend()<br>
plt.show()<br>
</div>

<span class="testo dot1">Valutazione del modello creato</span>

<div class="dot">
# set model for evalutation  <br><br>
convae.eval()<br>
<br>

with torch.no_grad():<br>
<span style="margin-left:30px">randomz = torch.randn(batch_size,3,64,64).to(device)</span><br>
 <span style="margin-left:30px">nuova_immagine = convae(randomz)[0]</span><br>

<br><br>
plt.subplot(1,2,1)<br>
plt.axis("off")<br>
plt.title("nuova_immagine")<br>
plt.imshow(np.transpose(vutils.make_grid(nuova_immagine.to(device)[:1], padding=2, normalize=True).cpu(),(1,2,0)))<br>
plt.show()<br>
</div>

cvarRis.png

 </div>







</body>

</html>